<script setup>
import {ref} from "vue";
import {toastViewerInstance} from "~/useToastViewer";

const color = useColor();
const route = useRoute();
const groupId = route.params.groupId;
const groupName = useGroup();
const documentList = useDocumentList();
const attachedFile = useAttachedFile();
const createDocument = useCreateDocument();
const postForm = ref();
const hover = ref(null);
const dialog = ref(false);
const upLinkId = ref();
const viewer = ref();

// Ï≤®Î∂ÄÌååÏùº Í¥ÄÎ†®
const files = ref([]);
const fileHover = ref(null);
const fileDialog = ref(false);
const fileLoading = ref(false);

// Î∂ÅÎßàÌÅ¨ Í¥ÄÎ†®
const selection = ref([]);
const bookmarks = useBookMarks();

await documentList.setDocumentList(groupId);
await groupName.setSelectedGroupInfo(groupId)
await documentList.setFirstDocumentDetails()

await attachedFile.setAttachedFileList(documentList.getFirstDocId);

groupName.setTopNaviGroupList(groupId);

const openCreateNewDocument = (docId) => {
  upLinkId.value = docId;
  dialog.value = true;
  console.log(upLinkId.value)
};

const handleData = async (form) => {
  form.groupId = groupId;
  form.upLinkId = upLinkId.value

  const temp = await createDocument.createNewDocument(form)
  await documentList.setDocumentList(groupName.getSelectedGroupInfo[0].groupId);
  await selectDocument(temp.documentId);
  dialog.value = false;
};

// Î¨∏ÏÑú ÏÑ†ÌÉù Ïãú ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
const selectDocument = async (documentId) => {
  // Î¨∏ÏÑúÏùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¥
  await documentList.setDocumentDetails(documentId);
  await attachedFile.setAttachedFileList(documentId);
  viewer.value = toastViewerInstance(
      viewer.value,
      documentList.selectedDocumentDetails.content
  );
};

// ÌååÏùº ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
const handleFileUpload = async () => {
  fileLoading.value = true; // ÎπôÍ∏ÄÏù¥ ÏãúÏûë
  await wait(1200); // 1.2Ï¥à ÎåÄÍ∏∞
  // Í∞Å ÌååÏùºÏóê ÎåÄÌï¥ ÏóÖÎ°úÎìú Î°úÏßÅ Ïã§Ìñâ
  for (let file of files.value) {
    console.log(file)
    await attachedFile.setAttachedFileUpload(documentList.selectedDocumentDetails.documentId, file);
  }
  files.value = []; // ÌååÏùº Î™©Î°ù Ï¥àÍ∏∞Ìôî

  // ÌååÏùº ÏóÖÎ°úÎìú ÌõÑ Ï≤®Î∂ÄÌååÏùº Î™©Î°ù Îã§Ïãú Î∂àÎü¨Ïò§Í∏∞
  await attachedFile.setAttachedFileList(documentList.selectedDocumentDetails.documentId);

  fileLoading.value = false; // ÎπôÍ∏ÄÏù¥ ÎÅùÎÇ¥Í∏∞
  fileDialog.value = false; // Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
};

// ÌååÏùº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
const handleFileClick = (url) => {
  window.open(url, '_blank');
};

// Ï≤®Î∂ÄÌååÏùº ÏÇ≠Ï†ú Î°úÏßÅ
const AttachedFileDelete = async (fileId) => {
  await attachedFile.setAttachedFileDelete(fileId);
  await wait(2000); // 1.2Ï¥à ÎåÄÍ∏∞
  // Ï≤®Î∂ÄÌååÏùº ÏÇ≠Ï†ú ÌõÑ Ï≤®Î∂ÄÌååÏùº Î™©Î°ù Îã§Ïãú Î∂àÎü¨Ïò§Í∏∞
  await attachedFile.setAttachedFileList(documentList.selectedDocumentDetails.documentId);
};

// ÏÑ†ÌÉùÌïú Î¨∏ÏÑú IDÍ∞Ä Î∂ÅÎßàÌÅ¨ Î™©Î°ùÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
const isBookmarked = computed(() =>
    bookmarks.myBookMarks.some(book => book.documentId === documentList.selectedDocumentDetails.documentId)
);

// Î∂ÅÎßàÌÅ¨ Î≤ÑÌäº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
const handleBookmarkClick = async () => {
  // ÎßåÏïΩ ÌòÑÏû¨ Î¨∏ÏÑúÍ∞Ä Î∂ÅÎßàÌÅ¨ÎêòÏñ¥ ÏûàÎã§Î©¥, Î∂ÅÎßàÌÅ¨Î•º Ï†úÍ±∞ÌïòÎäî Ïï°ÏÖòÏùÑ Ïã§ÌñâÌï©ÎãàÎã§.
  if (isBookmarked.value) {
    await bookmarks.removeMyBookmark(documentList.selectedDocumentDetails.documentId);
  } else {
    await bookmarks.removeMyBookmark(documentList.selectedDocumentDetails.documentId);
  }

  // Î∂ÅÎßàÌÅ¨ ÏÉÅÌÉúÎ•º Í∞±Ïã†Ìï©ÎãàÎã§.
  await bookmarks.setMyBookMarks();
};

// Ìï¥ÏãúÌÉúÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ Í¥ÄÎ†®
const hashTagUpdateModal = ref(false);
const hashTagsUpdateReqDto = ref({
  documentId: "",
  hashTags: []
});
const hashTagUpdateModalOpen = () => {
  hashTagUpdateModal.value = true
  hashTagsUpdateReqDto.value.documentId = documentList.getSelectedDocId
  hashTagsUpdateReqDto.value.hashTags = documentList.getHashTagsInSelectedDoc
}
const hashTagUpdateReq = () => {
  documentList.updateHashTags(hashTagsUpdateReqDto.value)
  hashTagUpdateModal.value = false;
}
// Î¨∏ÏÑú Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏ Í¥ÄÎ†®
const titleLoding = ref(false)
const handlerForUpdateModal = ref(false);
const updateDocumentTitleReq = ref({
  targetDocumentId: "",
  newTitle: ""
})
const OpenTitleUpdateModal = () => {
  handlerForUpdateModal.value = true
  updateDocumentTitleReq.value.targetDocumentId = documentList.getSelectedDocId
  updateDocumentTitleReq.value.newTitle = documentList.getSelectedDocTitle
}
const realUpdateDocumentTitle = async (event) => {
  titleLoding.value = true
  const results = await event
  await wait(500); // 0.5Ï¥à ÎåÄÍ∏∞

  if (results.valid) {
    await documentList.updateDocumentTitle(updateDocumentTitleReq.value)
    await documentList.setDocumentList(groupName.getSelectedGroupInfo[0].groupId);
    await documentList.setDocumentDetails(
        updateDocumentTitleReq.value.targetDocumentId)
    handlerForUpdateModal.value = false
  }
  titleLoding.value = false
}

</script>

<template>
  <v-container fluid>
    <v-row no-gutters>

      <!-- üëàüëàüëàüëàüëàüëàüëàüëà ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î -->
      <v-col cols="3">
        <v-list class="pa-4">
          <v-list-item>
            <v-list-item-title class="font-weight-bold headline text-center mt-2 mb-6">
              {{ groupName.getSelectedGroupInfo[0].groupName }}
              {{ `${groupName.getSelectedGroupInfo[0].groupType === 'DEPARTMENT' ? 'üè¢' : 'üöÄ'}` }}
            </v-list-item-title>
          </v-list-item>
          <v-divider></v-divider>
          <!-- Í∑∏Î£π Î¨∏ÏÑú title Ï∂úÎ†• -->

          <v-tabs color="primary" direction="vertical" class="mt-4">
            <v-tab
                v-for="doc in documentList.getDocumentList"
                :key="doc.documentId"
                @click="selectDocument(doc.documentId)"
                @mouseenter="hover = doc.documentId"
                @mouseleave="hover = null"
            >

              <h3 v-if="doc.docType === 'SECTION'">üîπÔ∏è {{ doc.title }} </h3>
              <div v-else>
                  {{ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' }} {{ doc.title }}
              </div>

              <template v-if="hover === doc.documentId" v-slot:append>
                <v-btn
                    :icon="`mdi-plus`"
                    variant="text"
                    density="compact"
                    rounded="lg"
                    @click.stop="openCreateNewDocument(doc.documentId)"
                />
              </template>
            </v-tab>
          </v-tabs>
        </v-list>
        <v-dialog v-model="dialog" fullscreen>
          <v-card>
            <PostForm ref="postForm" @submit="handleData"></PostForm>
            <v-card-actions>
              <v-spacer></v-spacer>
              <v-btn  @click=postForm.submit()>ÏûëÏÑ± ÏôÑÎ£å</v-btn>
              <v-btn  @click="dialog = false">Îã´Í∏∞</v-btn>
            </v-card-actions>
          </v-card>
        </v-dialog>
      </v-col>

      <!-- ÏÑ∏Î°úÏÑ† -->
      <v-divider class="divider-container" vertical></v-divider>

      <!-- ‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è‚òùÔ∏è Í∞ÄÏö¥Îç∞ Î¨∏ÏÑúÏ†úÎ™© Î∂ÄÎ∂Ñ -->
      <v-col cols="7">

        <v-list class="pa-4 mb-4" >
          <v-card flat>
            <v-row>
              <v-col cols="8" offset="2">
                <div class="d-flex justify-center">
                  <v-card-title class="headline text-center mb-4">
                    {{ documentList.selectedDocumentDetails.title }}
                  </v-card-title>

                  <v-item-group v-model="selection">
                    <v-item>
                      <v-btn
                          density="comfortable"
                          @click="handleBookmarkClick"
                          :icon="isBookmarked ? 'mdi-star' : 'mdi-star-outline'"
                      ></v-btn>
                    </v-item>
                  </v-item-group>
                </div>
              </v-col>
              <v-col cols="2">
                <v-btn
                    :icon="`mdi-pencil`"
                    variant="elevated"
                    rounded="lg"
                    class="mb-2 ml-2"
                    @click.stop="OpenTitleUpdateModal"
                />
              </v-col>
            </v-row>
          </v-card>

          <!--           üìú Î¨∏ÏÑú Ï†úÎ™©ÏàòÏ†ïÏùÑ ÏúÑÌïú Î™®Îã¨. -->
          <v-dialog
              class="d-flex justify-center"
              width="40vw"
              opacity="50%"
              v-model="handlerForUpdateModal">
            <v-sheet
                rounded="xl"
                class="d-flex justify-center flex-wrap pa-10">

              <v-form ref="form" style="width: 50vw" @submit.prevent="realUpdateDocumentTitle">
                <v-row>
                  <v-col>

                    <v-text-field
                        label="Î¨∏ÏÑú Ï†úÎ™© ÏûÖÎ†•"
                        placeholder="Î≥ÄÍ≤ΩÌï† Î¨∏ÏÑúÎ™ÖÏùÑ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî."
                        v-model="updateDocumentTitleReq.newTitle"
                        :rules="[value => !!value || 'Ïù¥Î¶Ñ ÏûÖÎ†•Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.']"
                        clearable
                        required
                    />

                    <v-btn
                        class="mt-7"
                        :color="color.kipMainColor"
                        :loading="titleLoding"
                        text="Î¨∏ÏÑú Ï†úÎ™© Î≥ÄÍ≤Ω"
                        type="submit"
                        block
                    />
                  </v-col>
                </v-row>
              </v-form>
            </v-sheet>
          </v-dialog>
          <!-- Í∞ÄÎ°ú ÏÑ† Ï∂îÍ∞Ä -->
          <v-divider></v-divider>
        </v-list>

        <v-card flat class="px-6 mt-4 mx-auto">
          <div ref="viewer">{{ documentList.selectedDocumentDetails.content }}</div>
        </v-card>

      </v-col>

      <!-- üëâüëâüëâüëâüëâüëâüëâüëâüëâ Ïò§Î•∏Ï™Ω ÏòÅÏó≠ -->
      <v-divider class="divider-container" vertical></v-divider>

      <v-col cols="2">
        <!-- Ï≤®Î∂Ä ÌååÏùº ÏÑπÏÖò -->
        <div class="attached-files">
          <v-card flat>
            <v-card-title class="headline text-center">Ï≤®Î∂Ä ÌååÏùº

              <!-- Ï≤®Î∂ÄÌååÏùº ÏóÖÎ°úÎìú Î°úÏßÅ Î∂ÄÎ∂Ñ -->
              <v-dialog
                  class="d-flex justify-center"
                  width="40vw"
                  opacity="50%"
                  v-model="fileDialog">
                <template v-slot:activator="{ props: activatorProps }">
                  <v-btn
                      class="mb-2 ml-2"
                      v-bind="activatorProps"
                      density="compact"
                      variant="flat"
                      icon="mdi-plus"
                  >
                  </v-btn>
                </template>

                <v-sheet
                    rounded="xl"
                    class="d-flex justify-center flex-wrap pa-10">

                  <v-form ref="form" style="width: 50vw">
                    <v-file-input
                        v-model="files"
                        label="Select files"
                        placeholder="Upload your documents"
                        prepend-icon="mdi-paperclip"
                        multiple
                    >
                      <template v-slot:selection="{ fileNames }">
                        <template v-for="fileName in fileNames" :key="fileName">
                          <v-chip class="me-2" color="primary" size="small" label>
                            {{ fileName }}
                          </v-chip>
                        </template>
                      </template>
                    </v-file-input>

                    <v-btn
                        class="mt-7"
                        :color="color.kipMainColor"
                        :loading="fileLoading"
                        text="ÏóÖÎ°úÎìú ÏôÑÎ£å"
                        @click="handleFileUpload"
                        block
                    />
                  </v-form>
                </v-sheet>
              </v-dialog>
            </v-card-title>


            <!-- Ï≤®Î∂ÄÌååÏùº Î™©Î°ù -->
            <v-card-text>
              <div v-if="attachedFile.getAttachedFileList.length > 0">
                <v-btn text color="primary"
                       v-for="file in attachedFile.getAttachedFileList"
                       :key="file.fileName"
                       @click="handleFileClick(file.fileUrl)"
                       @mouseenter="fileHover = file.fileName"
                       @mouseleave="fileHover = null">

                  {{ file.fileName }}

                  <v-dialog max-width="500">
                    <template v-slot:activator="{ props: activatorProps }" v-if="fileHover === file.fileName">
                      <v-btn
                          v-bind="activatorProps"
                          :icon="`mdi-minus`"
                          variant="text"
                          density="compact"
                          rounded="lg"
                      />
                    </template>

                    <template v-slot:default="{ isActive }">
                      <v-card title="Ï≤®Î∂ÄÌååÏùº ÏÇ≠Ï†ú">
                        <v-card-text>
                          Ï≤®Î∂ÄÌååÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                        </v-card-text>

                        <v-card-actions>
                          <v-spacer></v-spacer>

                          <v-snackbar
                              :timeout="2000"
                          >
                            <template v-slot:activator="{ props }">
                              <v-btn
                                  v-bind="props"
                                  @click="AttachedFileDelete(file.id)"

                              >Yes
                              </v-btn>
                            </template>
                            Ï≤®Î∂ÄÌååÏùºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.
                          </v-snackbar>

                          <v-btn
                              text="No"
                              @click="isActive.value = false"
                          ></v-btn>
                        </v-card-actions>
                      </v-card>
                    </template>

                  </v-dialog>
                </v-btn>
              </div>
              <div v-else>Ï≤®Î∂ÄÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</div>
            </v-card-text>
          </v-card>
        </div>

        <!--    ‚è©‚è©‚è©‚è©‚è©  Ìï¥ÏãúÌÉúÍ∑∏ -->
        <v-chip prepend-icon="mdi-pencil"
                color="blue"
                class="mx-4 mb-0 mt-5"
                @click="hashTagUpdateModalOpen"> Ìï¥Ïãú ÌÉúÍ∑∏ ÏàòÏ†ï
        </v-chip>

        <v-chip-group column class="px-4"
                      v-if="documentList.selectedDocumentDetails
                      && documentList.selectedDocumentDetails.hashTags.length > 0">
          <v-chip prepend-icon="mdi-refresh"
                  @click=documentList.setDocumentList(groupName.getSelectedGroupInfo[0].groupId)> Ï¥àÍ∏∞Ìôî
          </v-chip>
          <v-chip
              v-for="(hashTag, index) in documentList.selectedDocumentDetails.hashTags"
              :key="index"
              prepend-icon="mdi-pound"
              @click="documentList.filterGroupDocByHashTag(hashTag['hashTagId'])">
            {{ hashTag.tagName }} ({{ hashTag['docsCounts'] }})
          </v-chip>
        </v-chip-group>
        <div v-else class="pa-4">Ìï¥ÏãúÌÉúÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
      </v-col>

      <!--           ‚ù§Ô∏è Ìï¥ÏãúÌÉúÍ∑∏ ÏàòÏ†ïÏùÑ ÏúÑÌïú Î™®Îã¨-->
      <v-dialog
          class="d-flex justify-center"
          width="40vw"
          opacity="40%"
          v-model="hashTagUpdateModal">
        <v-sheet
            rounded="xl"
            class="d-flex justify-center flex-wrap pa-10">
          <v-combobox
              variant="underlined"
              v-model="hashTagsUpdateReqDto.hashTags"
              multiple
              chips
              placeholder="ÌÉúÍ∑∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."
              persistent-placeholder
              hint="Ïó¨Îü¨ ÌÉúÍ∑∏Î•º ÏóîÌÑ∞Î°ú Íµ¨Î∂ÑÌïòÏó¨ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."/>
          <v-btn
              class="mt-4"
              :color="color.kipMainColor"
              text="Ìï¥ÏãúÌÉúÍ∑∏ ÏàòÏ†ïÌïòÍ∏∞"
              @click="hashTagUpdateReq"
              block
          />
        </v-sheet>
      </v-dialog>
    </v-row>
  </v-container>
</template>

<style scoped>
.font-weight-bold {
  font-weight: bold;
}

.headline {
  font-size: 1.5rem;
  font-weight: bold;
}

.divider-container {
  min-height: calc(97vh - 1.6vw - 90px);
}
</style>